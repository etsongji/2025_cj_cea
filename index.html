<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>창의적 체험활동 관리 시스템</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Calendar, Clock, BookOpen, Users, Heart, Search, Filter, Edit3, Save, Plus, X, Download, Upload, FileText, AlertCircle, Trash2, RotateCcw } = lucide;

        const CreativeActivitySystem = () => {
          const [selectedGrade, setSelectedGrade] = useState('3');
          const [allActivities, setAllActivities] = useState({
            '1': [
              // 1학년 자율 활동
              { id: 101, date: '2025.03.05', time: 2, period: '5,6', domain: '자율', content: '신입생 오리엔테이션', note: '' },
              { id: 102, date: '2025.03.12', time: 1, period: '7', domain: '자율', content: '학급조직 및 임원선출', note: '' },
              { id: 103, date: '2025.04.09', time: 2, period: '6,7', domain: '자율', content: '생활규정 교육', note: '' },
              { id: 104, date: '2025.05.14', time: 1, period: '6', domain: '자율', content: '진로탐색 교육', note: '' },
              // 1학년 진로 활동
              { id: 105, date: '2025.03.19', time: 2, period: '5,6', domain: '진로', content: '진로흥미검사', note: '' },
              { id: 106, date: '2025.04.23', time: 3, period: '5,6,7', domain: '진로', content: '직업세계 이해', note: '' },
              { id: 107, date: '2025.05.15', time: 2, period: '5,6', domain: '진로', content: '진로체험활동', note: '' },
              // 1학년 동아리 활동
              { id: 108, date: '2025.03.26', time: 2, period: '6,7', domain: '동아리', content: '동아리 조직', note: '' },
              { id: 109, date: '2025.04.16', time: 3, period: '5,6,7', domain: '동아리', content: '학술동아리 활동', note: '' },
              { id: 110, date: '2025.05.21', time: 2, period: '6,7', domain: '동아리', content: '예술동아리 활동', note: '' },
              // 1학년 봉사 활동
              { id: 111, date: '2025.04.02', time: 1, period: '7', domain: '봉사', content: '교내 환경정화', note: '(환경보호활동)' },
              { id: 112, date: '2025.05.07', time: 2, period: '6,7', domain: '봉사', content: '지역사회 봉사', note: '(지역사회활동)' },
              { id: 113, date: '2025.06.11', time: 1, period: '7', domain: '봉사', content: '교내 도서관 정리', note: '(교육활동)' }
            ],
            '2': [
              // 2학년 자율 활동
              { id: 201, date: '2025.03.05', time: 2, period: '6,7', domain: '자율', content: '학급특색활동 계획', note: '' },
              { id: 202, date: '2025.03.19', time: 1, period: '6', domain: '자율', content: '안전교육', note: '' },
              { id: 203, date: '2025.04.09', time: 3, period: '5,6,7', domain: '자율', content: '민주시민교육', note: '' },
              { id: 204, date: '2025.05.14', time: 2, period: '6,7', domain: '자율', content: '리더십 교육', note: '' },
              // 2학년 진로 활동
              { id: 205, date: '2025.03.12', time: 3, period: '5,6,7', domain: '진로', content: '진로적성검사', note: '' },
              { id: 206, date: '2025.04.23', time: 2, period: '5,6', domain: '진로', content: '대학탐방', note: '' },
              { id: 207, date: '2025.05.15', time: 3, period: '5,6,7', domain: '진로', content: '직업인 특강', note: '' },
              // 2학년 동아리 활동
              { id: 208, date: '2025.03.26', time: 3, period: '5,6,7', domain: '동아리', content: '체육동아리 활동', note: '' },
              { id: 209, date: '2025.04.16', time: 2, period: '6,7', domain: '동아리', content: '과학실험동아리', note: '' },
              { id: 210, date: '2025.05.21', time: 3, period: '5,6,7', domain: '동아리', content: '문학동아리 활동', note: '' },
              // 2학년 봉사 활동
              { id: 211, date: '2025.04.02', time: 1, period: '7', domain: '봉사', content: '후배 멘토링', note: '(교육활동)' },
              { id: 212, date: '2025.05.07', time: 2, period: '6,7', domain: '봉사', content: '복지관 봉사', note: '(복지활동)' },
              { id: 213, date: '2025.06.11', time: 1, period: '7', domain: '봉사', content: '캠페인 활동', note: '(캠페인활동)' }
            ],
            '3': [
              // 3학년 자율 활동
              { id: 1, date: '2025.03.05', time: 1, period: '6', domain: '자율', content: '생명존중 교육', note: '' },
              { id: 2, date: '2025.03.05', time: 1, period: '7', domain: '자율', content: '학급특색지향활동', note: '' },
              { id: 3, date: '2025.03.12', time: 1, period: '5', domain: '자율', content: '입학식/시업식', note: '입학식/시업식' },
              { id: 4, date: '2025.03.19', time: 2, period: '6,7', domain: '자율', content: '학급특색지향활동', note: '' },
              { id: 5, date: '2025.03.26', time: 1, period: '7', domain: '자율', content: '안전교육', note: '' },
              
              { id: 6, date: '2025.04.09', time: 2, period: '5,6', domain: '자율', content: '학급특색지향활동', note: '' },
              { id: 7, date: '2025.04.09', time: 2, period: '6', domain: '자율', content: '진로집단상담 및 진로체험학습교육', note: '' },
              { id: 8, date: '2025.05.14', time: 3, period: '6', domain: '자율', content: '미세먼지교육', note: '' },
              { id: 9, date: '2025.05.14', time: 3, period: '7', domain: '자율', content: '장애이해교육', note: '' },
              { id: 10, date: '2025.05.15', time: 2, period: '1,2', domain: '자율', content: '체육한마당', note: '' },
              { id: 11, date: '2025.05.16', time: 2, period: '1,2', domain: '자율', content: '현장체험학습', note: '' },
              { id: 12, date: '2025.06.11', time: 2, period: '5', domain: '자율', content: '성교육', note: '' },
              { id: 13, date: '2025.06.11', time: 2, period: '6', domain: '자율', content: '교육활동 종례해설교육', note: '' },
              { id: 14, date: '2025.06.25', time: 3, period: '5', domain: '자율', content: '사이버폭력예방교육', note: '' },
              { id: 15, date: '2025.06.25', time: 3, period: '6', domain: '자율', content: '통일, 융공어어 등 역량 신장을 위한교육', note: '' },
              { id: 16, date: '2025.06.25', time: 3, period: '7', domain: '자율', content: '창의인재교육', note: '' },
              
              // 3학년 진로 활동
              { id: 17, date: '2025.03.12', time: 3, period: '5,6,7', domain: '진로', content: '진로 독서지도특화 및 학과별직업활동', note: '' },
              { id: 18, date: '2025.03.19', time: 3, period: '5,6,7', domain: '진로', content: '학과특색진로활동', note: '' },
              { id: 19, date: '2025.03.26', time: 2, period: '5,6', domain: '진로', content: '진로적성검사', note: '' },
              
              { id: 20, date: '2025.04.23', time: 3, period: '5,6,7', domain: '진로', content: '진로 독서프로젝트', note: '' },
              { id: 21, date: '2025.05.15', time: 1, period: '5', domain: '진로', content: '체육한마당', note: '' },
              { id: 22, date: '2025.05.16', time: 1, period: '5', domain: '진로', content: '현장체험학습', note: '' },
              { id: 23, date: '2025.08.20', time: 3, period: '5,6,7', domain: '진로', content: '미세먼지 수족혈관(구주행정청)', note: '' },
              
              // 3학년 동아리 활동
              { id: 24, date: '2025.03.05', time: 2, period: '5,6', domain: '동아리', content: '동아리 조직', note: '' },
              { id: 25, date: '2025.03.19', time: 2, period: '5,6', domain: '동아리', content: '수학동아리 활동', note: '' },
              { id: 26, date: '2025.03.26', time: 3, period: '5,6,7', domain: '동아리', content: '과학실험동아리', note: '' },
              
              { id: 27, date: '2025.04.16', time: 2, period: '6,7', domain: '동아리', content: '영어토론동아리', note: '' },
              { id: 28, date: '2025.05.21', time: 3, period: '5,6,7', domain: '동아리', content: '진로탐구동아리', note: '' },
              { id: 29, date: '2025.06.18', time: 2, period: '6,7', domain: '동아리', content: '창의융합동아리', note: '' },
              
              // 3학년 봉사 활동
              { id: 30, date: '2025.03.12', time: 1, period: '7', domain: '봉사', content: '환경정화활동', note: '(환경보호활동)' },
              { id: 31, date: '2025.03.26', time: 1, period: '6', domain: '봉사', content: '교내도서관정리', note: '(교육활동)' },
              
              { id: 32, date: '2025.04.09', time: 1, period: '7', domain: '봉사', content: '봉사소양교육', note: '(학업보충활동)' },
              { id: 33, date: '2025.05.15', time: 2, period: '6,7', domain: '봉사', content: '체육만한국당과 주변 정화활동', note: '(학업보충활동)' },
              { id: 34, date: '2025.05.16', time: 2, period: '6,7', domain: '봉사', content: '현장체험학습교과 주변 정화활동', note: '(학업보충활동)' },
              { id: 35, date: '2025.05.21', time: 3, period: '5,6,7', domain: '봉사', content: '내외 봉사의 날', note: '(아동복지활동)' },
              { id: 36, date: '2025.06.11', time: 1, period: '7', domain: '봉사', content: '학교 주변 정화활동', note: '(학업보충활동)' },
              { id: 37, date: '2025.07.15', time: 3, period: '5,6,7', domain: '봉사', content: '내외 봉사의 날', note: '(아동복지활동)' },
              { id: 38, date: '2025.08.27', time: 1, period: '7', domain: '봉사', content: '학교 주변 정화활동', note: '(학업보충활동)' },
              { id: 39, date: '2025.09.17', time: 1, period: '7', domain: '봉사', content: '학교 주변 정화활동', note: '(학업보충활동)' }
            ]
          });

          const activities = allActivities[selectedGrade] || [];
          const [searchTerm, setSearchTerm] = useState('');
          const [editingCell, setEditingCell] = useState(null);
          const [showAddForm, setShowAddForm] = useState(false);
          const [showExcelFormat, setShowExcelFormat] = useState(false);
          const [viewMode, setViewMode] = useState('table'); // 'table' 또는 'schedule'
          const [selectedMonth, setSelectedMonth] = useState('3');

          const [uploadProgress, setUploadProgress] = useState(false);

          const [newActivity, setNewActivity] = useState({
            date: '',
            time: '',
            period: '',
            domain: '자율',
            content: '',
            note: ''
          });

          const grades = ['1', '2', '3'];
          const months = [
            { value: '3', label: '3월' },
            { value: '4', label: '4월' },
            { value: '5', label: '5월' },
            { value: '6', label: '6월' },
            { value: '7', label: '7월' },
            { value: '8', label: '8월' },
            { value: '9', label: '9월' },
            { value: '10', label: '10월' },
            { value: '11', label: '11월' },
            { value: '12', label: '12월' }
          ];
          const domains = ['자율', '진로', '동아리', '봉사'];
          const domainColors = {
            '자율': 'bg-yellow-100',
            '진로': 'bg-green-100', 
            '동아리': 'bg-purple-100',
            '봉사': 'bg-pink-100'
          };

          // 교시 수 계산 함수 (예: "5,6,7" → 3시간)
          const calculatePeriodHours = (period) => {
            if (!period || period === '') return 0;
            const periods = period.split(',').map(p => p.trim()).filter(p => p !== '');
            return periods.length;
          };

          // 월별 시간표 데이터 생성
          const generateMonthlySchedule = () => {
            // 현재 선택된 학년의 활동들 가져오기
            const currentActivities = allActivities[selectedGrade] || [];
            
            // 선택된 월의 활동들만 필터링 (더 유연한 방식)
            const monthActivities = currentActivities.filter(activity => {
              const activityMonth = activity.date.split('.')[1];
              // 다양한 형태의 월 비교: "3", "03", "03" 등
              const normalizedActivityMonth = parseInt(activityMonth, 10).toString();
              const normalizedSelectedMonth = parseInt(selectedMonth, 10).toString();
              return normalizedActivityMonth === normalizedSelectedMonth;
            });

            // 날짜별로 그룹화
            const groupedByDate = monthActivities.reduce((groups, activity) => {
              const date = activity.date;
              if (!groups[date]) {
                groups[date] = {};
              }
              
              // 교시별로 정리
              const periods = activity.period.split(',').map(p => p.trim());
              periods.forEach(period => {
                if (!groups[date][period]) {
                  groups[date][period] = [];
                }
                groups[date][period].push({
                  domain: activity.domain,
                  content: activity.content,
                  time: calculatePeriodHours(activity.period)
                });
              });
              
              return groups;
            }, {});

            return groupedByDate;
          };

          // 월별 시간표 컴포넌트
          const MonthlyScheduleView = () => {
            const scheduleData = generateMonthlySchedule();
            const dates = Object.keys(scheduleData).sort();
            const periods = ['1', '2', '3', '4', '5', '6', '7'];

            if (dates.length === 0) {
              return React.createElement('div', { className: "text-center py-12" },
                React.createElement(Calendar, { className: "w-16 h-16 text-gray-300 mx-auto mb-4" }),
                React.createElement('h3', { className: "text-lg font-medium text-gray-500 mb-2" }, `${selectedMonth}월 활동이 없습니다`),
                React.createElement('p', { className: "text-gray-400" }, "해당 월에 등록된 창의적 체험활동이 없습니다.")
              );
            }

            return React.createElement('div', { className: "space-y-6" },
              React.createElement('div', { className: "flex justify-between items-center" },
                React.createElement('h2', { className: "text-xl font-bold" }, `${selectedGrade}학년 ${selectedMonth}월 창의적 체험활동 시간표`),
                React.createElement('select', {
                  value: selectedMonth,
                  onChange: (e) => setSelectedMonth(e.target.value),
                  className: "px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                }, months.map(month => 
                  React.createElement('option', { key: month.value, value: month.value }, month.label)
                ))
              ),
              React.createElement('div', { className: "overflow-x-auto" },
                React.createElement('table', { className: "w-full border-collapse border border-gray-400 text-sm" },
                  React.createElement('thead', null,
                    React.createElement('tr', { className: "bg-gray-200" },
                      React.createElement('th', { className: "border border-gray-400 px-3 py-2 font-bold w-32" }, "날짜"),
                      periods.map(period => 
                        React.createElement('th', { key: period, className: "border border-gray-400 px-3 py-2 font-bold w-24" }, `${period}교시`)
                      )
                    )
                  ),
                  React.createElement('tbody', null,
                    dates.map(date => 
                      React.createElement('tr', { key: date, className: "hover:bg-gray-50" },
                        React.createElement('td', { className: "border border-gray-400 px-3 py-3 font-medium bg-gray-100 text-center" },
                          React.createElement('div', { className: "text-sm font-bold" }, date),
                          React.createElement('div', { className: "text-xs text-gray-600" }, 
                            new Date(date.replace(/\./g, '-')).toLocaleDateString('ko-KR', { weekday: 'short' })
                          )
                        ),
                        periods.map(period => {
                          const periodActivities = scheduleData[date][period] || [];
                          return React.createElement('td', { key: period, className: "border border-gray-400 px-2 py-1 text-center" },
                            periodActivities.length > 0 
                              ? React.createElement('div', { className: "space-y-1" },
                                  periodActivities.map((activity, idx) => 
                                    React.createElement('div', {
                                      key: idx,
                                      className: `px-2 py-1 rounded text-xs font-medium border ${domainColors[activity.domain]} ${
                                        activity.domain === '자율' ? 'text-yellow-800' :
                                        activity.domain === '진로' ? 'text-green-800' :
                                        activity.domain === '동아리' ? 'text-purple-800' :
                                        'text-pink-800'
                                      }`
                                    },
                                      React.createElement('div', { className: "font-bold" }, activity.domain),
                                      React.createElement('div', { className: "text-xs mt-1 leading-tight" },
                                        activity.content.length > 10 
                                          ? `${activity.content.substring(0, 10)}...`
                                          : activity.content
                                      ),
                                      React.createElement('div', { className: "text-xs text-gray-600" }, `(${activity.time}h)`)
                                    )
                                  )
                                )
                              : React.createElement('div', { className: "text-gray-300 text-xs" }, "-")
                          );
                        })
                      )
                    )
                  )
                )
              ),
              React.createElement('div', { className: "mt-6 p-4 bg-gray-100 border rounded" },
                React.createElement('h3', { className: "font-bold mb-3" }, `${selectedMonth}월 활동 통계`),
                React.createElement('div', { className: "grid grid-cols-4 gap-4 text-center" },
                  domains.map(domain => {
                    const domainActivities = activities.filter(a => {
                      const activityMonth = a.date.split('.')[1];
                      const normalizedActivityMonth = parseInt(activityMonth, 10).toString();
                      const normalizedSelectedMonth = parseInt(selectedMonth, 10).toString();
                      return normalizedActivityMonth === normalizedSelectedMonth && a.domain === domain;
                    });
                    const totalHours = domainActivities.reduce((sum, a) => sum + calculatePeriodHours(a.period), 0);
                    return React.createElement('div', { key: domain, className: `p-3 rounded border ${domainColors[domain]}` },
                      React.createElement('h4', { className: "font-bold" }, domain),
                      React.createElement('p', { className: "text-sm" }, `${domainActivities.length}개 활동`),
                      React.createElement('p', { className: "text-lg font-bold" }, `${totalHours}시간`)
                    );
                  })
                )
              )
            );
          };

          // 영역별로 활동 필터링
          const getActivitiesByDomain = (domain) => {
            return activities
              .filter(activity => activity.domain === domain)
              .filter(activity => 
                searchTerm === '' || 
                activity.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                activity.date.includes(searchTerm) ||
                activity.note.toLowerCase().includes(searchTerm.toLowerCase())
              )
              .sort((a, b) => new Date(a.date.replace(/\./g, '-')) - new Date(b.date.replace(/\./g, '-')));
          };

          // 활동 추가
          const handleAddActivity = () => {
            if (newActivity.date && newActivity.period && newActivity.content) {
              const currentActivities = allActivities[selectedGrade] || [];
              const maxId = Math.max(0, ...Object.values(allActivities).flat().map(a => a.id));
              const id = maxId + 1;
              const updatedActivities = [...currentActivities, { 
                ...newActivity, 
                id, 
                time: parseInt(newActivity.time) || 1 
              }];
              
              setAllActivities({
                ...allActivities,
                [selectedGrade]: updatedActivities
              });
              
              setNewActivity({ date: '', time: '', period: '', domain: '자율', content: '', note: '' });
              setShowAddForm(false);
            }
          };

          // 셀 편집
          const handleCellEdit = (id, field, value) => {
            const currentActivities = allActivities[selectedGrade] || [];
            const updatedActivities = currentActivities.map(activity =>
              activity.id === id ? { ...activity, [field]: value } : activity
            );
            
            setAllActivities({
              ...allActivities,
              [selectedGrade]: updatedActivities
            });
            
            setEditingCell(null);
          };

          // 활동 삭제
          const handleDelete = (id) => {
            const currentActivities = allActivities[selectedGrade] || [];
            const updatedActivities = currentActivities.filter(activity => activity.id !== id);
            
            setAllActivities({
              ...allActivities,
              [selectedGrade]: updatedActivities
            });
          };

          // 파일 업로드 처리 (CSV와 엑셀 모두 지원)
          const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setUploadProgress(true);
            
            try {
              let jsonData = [];
              
              if (file.name.endsWith('.csv')) {
                // CSV 파일 처리 - 개선된 파싱
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                  alert('CSV 파일에 데이터가 없습니다.');
                  return;
                }

                // 첫 번째 줄에서 헤더 추출
                const headerLine = lines[0];
                const headers = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let i = 0; i < headerLine.length; i++) {
                  const char = headerLine[i];
                  if (char === '"') {
                    inQuotes = !inQuotes;
                  } else if (char === ',' && !inQuotes) {
                    headers.push(currentField.trim());
                    currentField = '';
                  } else {
                    currentField += char;
                  }
                }
                headers.push(currentField.trim());

                // 데이터 행 처리
                for (let i = 1; i < lines.length; i++) {
                  const line = lines[i];
                  const values = [];
                  let currentValue = '';
                  let inQuotes = false;
                  
                  for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                      values.push(currentValue.trim());
                      currentValue = '';
                    } else {
                      currentValue += char;
                    }
                  }
                  values.push(currentValue.trim());

                  // 행 데이터를 객체로 변환
                  const row = {};
                  headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                  });
                  
                  if (Object.values(row).some(val => val.trim())) {
                    